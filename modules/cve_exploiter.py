"""Auto CVE Exploit Runner — match CVEs to public exploits and generate scripts."""

import aiohttp
import asyncio
import os
import json
from modules.core import console

async def _search_exploitdb(session, cve_id):
    """Search ExploitDB for public exploits via API."""
    try:
        url = f'https://exploit-db.com/search?cve={cve_id}'
        headers = {'User-Agent': 'Mozilla/5.0'}
        async with session.get(url, timeout=aiohttp.ClientTimeout(total=10),
                               ssl=False, headers=headers) as resp:
            if resp.status == 200:
                body = await resp.text()
                if 'exploit' in body.lower() and cve_id in body:
                    return {'source': 'ExploitDB', 'url': url}
    except Exception:
        pass
    return None


async def _search_github_poc(session, cve_id):
    """Search GitHub for PoC exploits."""
    try:
        url = f'https://api.github.com/search/repositories?q={cve_id}+poc&sort=stars&per_page=3'
        headers = {'Accept': 'application/vnd.github.v3+json', 'User-Agent': 'Snakebite'}
        async with session.get(url, timeout=aiohttp.ClientTimeout(total=15),
                               ssl=False, headers=headers) as resp:
            if resp.status == 200:
                data = await resp.json()
                items = data.get('items', [])
                if items:
                    return [{
                        'source': 'GitHub',
                        'name': item['full_name'],
                        'url': item['html_url'],
                        'stars': item['stargazers_count'],
                        'description': item.get('description', '')[:100],
                    } for item in items[:3]]
    except Exception:
        pass
    return []


async def _search_nvd(session, cve_id):
    """Get CVE details from NVD API."""
    try:
        url = f'https://services.nvd.nist.gov/rest/json/cves/2.0?cveId={cve_id}'
        async with session.get(url, timeout=aiohttp.ClientTimeout(total=15), ssl=False) as resp:
            if resp.status == 200:
                data = await resp.json()
                vulns = data.get('vulnerabilities', [])
                if vulns:
                    cve_data = vulns[0].get('cve', {})
                    metrics = cve_data.get('metrics', {})
                    cvss_v3 = metrics.get('cvssMetricV31', [{}])
                    score = cvss_v3[0].get('cvssData', {}).get('baseScore', 0) if cvss_v3 else 0
                    descriptions = cve_data.get('descriptions', [])
                    desc = descriptions[0].get('value', '') if descriptions else ''
                    return {
                        'id': cve_id,
                        'score': score,
                        'description': desc[:200],
                        'severity': cvss_v3[0].get('cvssData', {}).get('baseSeverity', '') if cvss_v3 else '',
                    }
    except Exception:
        pass
    return None


def _generate_exploit_script(cve_info, poc_repos):
    """Generate a meta-exploit script that references found PoC repos."""
    script = f'''#!/usr/bin/env python3
"""
Auto-generated CVE Exploit Runner — {cve_info.get('id', 'UNKNOWN')}
CVSS Score: {cve_info.get('score', 'N/A')}
Severity: {cve_info.get('severity', 'N/A')}
Description: {cve_info.get('description', '')[:150]}

Public PoC References:
'''
    for poc in poc_repos:
        script += f"  - {poc.get('name', '')}: {poc.get('url', '')}\n"

    script += f'''
Generated by Snakebite Auto Exploit Engine
"""
import subprocess
import sys
import os

CVE_ID = "{cve_info.get('id', '')}"
TARGET = sys.argv[1] if len(sys.argv) > 1 else ""

def main():
    if not TARGET:
        print(f"Usage: python {{sys.argv[0]}} <target_url>")
        sys.exit(1)
    
    print(f"[*] CVE: {{CVE_ID}}")
    print(f"[*] Target: {{TARGET}}")
    print(f"[*] CVSS Score: {cve_info.get('score', 'N/A')}")
    print()
    
    # Clone and run PoC if available
    poc_repos = {json.dumps([p.get('url', '') for p in poc_repos[:3]])}
    
    for repo_url in poc_repos:
        if repo_url:
            repo_name = repo_url.split("/")[-1]
            print(f"[*] PoC Repository: {{repo_url}}")
            print(f"[*] Clone: git clone {{repo_url}}")
            print(f"[*] Then follow the README for exploitation steps")
            print()
    
    print("[!] Always verify exploits in a controlled environment")
    print("[!] Use responsibly and only with authorization")

if __name__ == "__main__":
    main()
'''
    return script


async def scan_cve_exploits(session, findings):
    """Search for public exploits for discovered CVEs."""
    console.print(f"\n[bold cyan]--- Auto CVE Exploit Runner ---[/bold cyan]")

    cve_ids = set()
    for finding in findings:
        cve_list = finding.get('cves', [])
        if isinstance(cve_list, list):
            for cve in cve_list:
                if isinstance(cve, str) and cve.startswith('CVE-'):
                    cve_ids.add(cve)
        cve_id = finding.get('cve_id', '')
        if cve_id and cve_id.startswith('CVE-'):
            cve_ids.add(cve_id)

    if not cve_ids:
        console.print(f"  [dim]No CVE IDs found in scan results[/dim]")
        return {'cves_checked': 0, 'exploits_found': []}

    console.print(f"  [cyan]Searching exploits for {len(cve_ids)} CVEs...[/cyan]")

    results = {'cves_checked': len(cve_ids), 'exploits_found': [], 'scripts_generated': 0}
    exploit_dir = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'exploits')
    os.makedirs(exploit_dir, exist_ok=True)

    for cve_id in sorted(cve_ids):
        console.print(f"  [dim]Checking {cve_id}...[/dim]")

        nvd_info = await _search_nvd(session, cve_id)

        github_pocs = await _search_github_poc(session, cve_id)

        if github_pocs:
            console.print(f"  [bold red]⚡ {cve_id} — {len(github_pocs)} PoC(s) found![/bold red]")
            if nvd_info:
                console.print(f"    [dim]CVSS: {nvd_info.get('score', 'N/A')} ({nvd_info.get('severity', '')})[/dim]")

            for poc in github_pocs:
                console.print(f"    [red]⭐{poc['stars']} {poc['name']}[/red]")
                console.print(f"    [dim]{poc['url']}[/dim]")

            cve_info = nvd_info or {'id': cve_id}
            script = _generate_exploit_script(cve_info, github_pocs)
            script_path = os.path.join(exploit_dir, f'exploit_{cve_id.replace("-", "_")}.py')
            with open(script_path, 'w') as f:
                f.write(script)
            results['scripts_generated'] += 1

            results['exploits_found'].append({
                'cve': cve_id,
                'score': nvd_info.get('score', 0) if nvd_info else 0,
                'pocs': github_pocs,
                'script': script_path,
            })

        await asyncio.sleep(0.5)

    if results['exploits_found']:
        console.print(f"\n  [bold red]{len(results['exploits_found'])} CVEs with public exploits![/bold red]")
        console.print(f"  [green]{results['scripts_generated']} exploit scripts generated in exploits/[/green]")
    else:
        console.print(f"\n  [green]✓ No public exploits found for detected CVEs[/green]")

    return results
